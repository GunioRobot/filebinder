h1. Filebinder: Simple file attachment plugin for CakePHP

h2. Simple Usage

 Example of how to attachment image file with confirm page.

<pre>
class Post extends AppModel {
    var $name = 'Post';
    var $actsAs = array('Filebinder.Bindable' => array('model' => 'Attachment'));
    var $displayField = 'title';

    var $bindFields = array(array('field' => 'attachment_file',
                                  'tmpPath' => '/var/www/html/myapp/app/webroot/files/cache/',
                                  'filePath' => '/var/www/html/myapp/app/webroot/files/',
                                  ));
  }
</pre>

 Create attachment table.

<pre>
CREATE TABLE `attachments` (
  `id` tinyint(4) NOT NULL AUTO_INCREMENT,
  `model` text NOT NULL,
  `model_id` int(11) NOT NULL,
  `filed_name` text NOT NULL,
  `file_name` text NOT NULL,
  `file_content_type` text NOT NULL,
  `file_size` int(11) NOT NULL,
  `file_object` longtext,
  `created` datetime DEFAULT NULL,
  `modified` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</pre>


<pre>
<?php
class PostsController extends AppController {

    var $name = 'Posts';
    var $components = array('Session', 'Filebinder.Ring', 'Transition');

    /**
     * add
     */
    function add() {
        $this->Ring->bindUp();
        $this->Transition->checkData('add_confirm');
        $this->Transition->clearData();
    }

    /**
     * add_confirm
     */
    function add_confirm(){
        $this->Transition->checkPrev(array('add'));

        $this->Transition->automate('add_success',
                                    false,
                                    'add');
        $mergedData = $this->Transition->mergedData();
        $this->set('mergedData', $mergedData);
    }

    /**
     * add_success
     */
    function add_success(){
        $this->Transition->checkPrev(array('add',
                                           'add_confirm'));
        $mergedData = $this->Transition->mergedData();

        if ($this->Post->save($mergedData)) {
            $this->Transition->clearData();
            $this->Session->setFlash(sprintf(__('The %s has been saved', true), 'post'));
            $this->redirect(array('action' => 'index'));
        } else {
            $this->Session->setFlash(sprintf(__('The %s could not be saved. Please, try again.', true), 'post'), 'flash_error');
            $this->redirect(array('action' => 'add'));
        }
    }
}
</pre>

 add.ctp
<pre>
<div class="posts form">
    <h2><?php printf(__('Add %s', true), __('Post', true)); ?></h2>
    <?php echo $this->Form->create('Post', array('action' => 'add', 'type' => 'file'));?>
    <?php echo $this->Form->input('title', array('type' => 'text'));?>
    <?php echo $this->Form->input('body'));?>
    <?php echo $this->Form->input('attachment_file', array('type' => 'file'));?>
    <?php echo $this->Form->submit(__('Submit', true));?>
    <?php echo $this->Form->end();?>
</div>
</pre>

 add_confirm.ctp
<pre>
<div class="posts form">
    <h2><?php printf(__('Confirm %s', true), __('Post', true)); ?></h2>
    
    <?php echo h($mergedData['Post']['title']);?>
    <?php echo h($mergedData['Post']['body']);?>
    <?php echo $this->Html->image(preg_replace('#' . WWW_ROOT . '#', '../', $mergedData['Post']['attachment_file']['tmp_bind_path']));?> 
    <?php echo $this->Form->create('Post', array('action' => 'add_confirm'));?>   
    <?php echo $this->Form->submit(__('Submit', true));?>
    <?php echo $this->Form->end();?>
</div>
</pre>